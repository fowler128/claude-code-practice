<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 13 Plan Payment Calculator - Southern District of Texas, Houston Division</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #1a365d;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1.3rem;
        }

        .card h3 {
            color: #2d3748;
            margin: 15px 0 10px 0;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .creditor-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3182ce;
        }

        .creditor-item.priority {
            border-left-color: #d69e2e;
        }

        .creditor-item.unsecured {
            border-left-color: #718096;
        }

        .creditor-item h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .btn {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
        }

        .btn-add {
            background: #48bb78;
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
            margin-top: 10px;
        }

        .btn-remove {
            background: #e53e3e;
            padding: 5px 10px;
            font-size: 0.8rem;
            width: auto;
            float: right;
        }

        .results-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
        }

        .results-card h2 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.2);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item .label {
            color: #a0aec0;
        }

        .result-item .value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .result-item.total {
            background: rgba(49, 130, 206, 0.2);
            margin: 15px -25px;
            padding: 15px 25px;
            border-radius: 8px;
        }

        .result-item.total .label,
        .result-item.total .value {
            font-size: 1.3rem;
            color: #63b3ed;
        }

        .result-item.monthly-payment {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            margin: 20px -25px -25px -25px;
            padding: 20px 25px;
            border-radius: 0 0 12px 12px;
        }

        .result-item.monthly-payment .label,
        .result-item.monthly-payment .value {
            font-size: 1.5rem;
            color: white;
        }

        .breakdown-section {
            margin-top: 20px;
        }

        .breakdown-section h3 {
            color: #a0aec0;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-box {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #2c5282;
        }

        .info-box.warning {
            background: #fffaf0;
            border-color: #fbd38d;
            color: #744210;
        }

        .info-box.conduit {
            background: #f0fff4;
            border-color: #9ae6b4;
            color: #22543d;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .trustee-section {
            background: #faf5ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #805ad5;
            margin-bottom: 15px;
        }

        .till-rate-section {
            background: #fffaf0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dd6b20;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5rem;
            }
        }

        .hidden {
            display: none;
        }

        .amortization-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .amortization-table th,
        .amortization-table td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .amortization-table th {
            color: #a0aec0;
            font-weight: 500;
        }

        .amortization-table td:first-child,
        .amortization-table th:first-child {
            text-align: left;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
        }

        .sub-section {
            background: #edf2f7;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .legal-note {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .legal-note a {
            color: #63b3ed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Chapter 13 Plan Payment Calculator</h1>
            <p>Southern District of Texas - Houston Division</p>
        </header>

        <div class="calculator-grid">
            <!-- Plan Details -->
            <div class="card">
                <h2>Plan Details</h2>

                <div class="info-box conduit">
                    <strong>SD Texas Conduit Requirement</strong>
                    Per Local Rule 3015-1, home mortgage payments are made through the Chapter 13 trustee (conduit treatment). The trustee fee applies to all payments including conduit mortgage payments.
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="planMonths">Plan Length (Months)</label>
                        <select id="planMonths">
                            <option value="36">36 Months</option>
                            <option value="48">48 Months</option>
                            <option value="60" selected>60 Months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trusteeFee">Trustee Fee (%)</label>
                        <input type="number" id="trusteeFee" value="10" step="0.1" min="0" max="15">
                    </div>
                </div>

                <div class="till-rate-section">
                    <div class="form-group">
                        <label for="primeRate">Current Prime Rate (%)</label>
                        <input type="number" id="primeRate" value="6.75" step="0.25" min="0" max="20">
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            As of January 2026. Used for Till rate calculation.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="riskAdjustment">Risk Adjustment (%)</label>
                        <input type="number" id="riskAdjustment" value="1.5" step="0.25" min="0" max="5">
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            Typically 1-3% per Till v. SCS Credit Corp.
                        </small>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <strong style="color: #744210;">Till Rate: <span id="tillRateDisplay">8.25%</span></strong>
                    </div>
                </div>

                <div class="trustee-section">
                    <div class="form-group">
                        <label for="unsecuredPercent">Unsecured Creditor Payment (%)</label>
                        <input type="number" id="unsecuredPercent" value="0" step="1" min="0" max="100">
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            Percentage of unsecured debt to pay (based on disposable income)
                        </small>
                    </div>
                </div>
            </div>

            <!-- Secured Creditors -->
            <div class="card">
                <h2>Secured Creditors</h2>
                <div class="info-box">
                    <strong>Conduit Mortgage Treatment (SD Texas)</strong>
                    Ongoing mortgage payments go THROUGH the trustee. Both arrears and current payments are included in the plan payment. Trustee fee (10%) applies to conduit payments.
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useTillRate" checked onchange="updateTillRateDisplay()">
                        <span>Use Till Rate for arrears interest (recommended)</span>
                    </label>
                </div>

                <div id="securedCreditors">
                    <!-- Creditors will be added here dynamically -->
                </div>

                <button class="btn btn-add" onclick="addSecuredCreditor()">+ Add Secured Creditor</button>
            </div>

            <!-- Priority Creditors -->
            <div class="card">
                <h2>Priority Creditors</h2>
                <div class="info-box">
                    <strong>Priority Claims</strong>
                    Must be paid in full (100%). No interest accrues on priority claims. Common priority claims include IRS taxes, state taxes (TWC), and domestic support obligations.
                </div>

                <div id="priorityCreditors">
                    <!-- Priority creditors will be added here dynamically -->
                </div>

                <button class="btn btn-add" onclick="addPriorityCreditor()">+ Add Priority Creditor</button>
            </div>

            <!-- Unsecured Creditors -->
            <div class="card">
                <h2>Unsecured Creditors</h2>
                <div class="info-box">
                    <strong>Unsecured Claims</strong>
                    Paid based on disposable income. May receive 0-100% of claims. No interest.
                </div>

                <div class="form-group">
                    <label for="totalUnsecured">Total Unsecured Debt</label>
                    <input type="number" id="totalUnsecured" value="100000" step="100">
                </div>
            </div>
        </div>

        <!-- Calculate Button -->
        <div style="max-width: 400px; margin: 0 auto 20px auto;">
            <button class="btn" onclick="calculatePlan()">Calculate Plan Payment</button>
        </div>

        <!-- Results -->
        <div class="calculator-grid">
            <div class="card results-card" id="resultsCard" style="display: none;">
                <h2>Plan Payment Summary</h2>

                <div class="breakdown-section">
                    <h3>Conduit Mortgage Payments (Through Trustee)</h3>
                    <div id="conduitBreakdown"></div>
                </div>

                <div class="breakdown-section">
                    <h3>Secured Claims - Arrears (Through Plan)</h3>
                    <div id="securedBreakdown"></div>
                </div>

                <div class="breakdown-section">
                    <h3>Priority Claims</h3>
                    <div id="priorityBreakdown"></div>
                </div>

                <div class="breakdown-section">
                    <h3>Unsecured Claims</h3>
                    <div id="unsecuredBreakdown"></div>
                </div>

                <div class="result-item total">
                    <span class="label">Total to Creditors</span>
                    <span class="value" id="totalToCreditors">$0.00</span>
                </div>

                <div class="result-item">
                    <span class="label">Trustee Fee (<span id="trusteeFeePercent">10</span>%)</span>
                    <span class="value" id="trusteeFeeAmount">$0.00</span>
                </div>

                <div class="result-item">
                    <span class="label">Total Plan Cost (60 months)</span>
                    <span class="value" id="totalPlanCost">$0.00</span>
                </div>

                <div class="result-item monthly-payment">
                    <span class="label">Monthly Plan Payment</span>
                    <span class="value" id="monthlyPayment">$0.00</span>
                </div>
            </div>

            <div class="card results-card" id="detailsCard" style="display: none;">
                <h2>Payment Breakdown Details</h2>

                <div class="breakdown-section">
                    <h3>Monthly Distribution (Before Trustee Fee)</h3>
                    <table class="amortization-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Monthly</th>
                                <th>Total (60 mo)</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyBreakdown">
                        </tbody>
                    </table>
                </div>

                <div class="breakdown-section">
                    <h3>Interest Rate Used</h3>
                    <div id="interestRateInfo"></div>
                </div>

                <div class="legal-note">
                    <strong>Legal References:</strong><br>
                    <a href="https://www.txs.uscourts.gov/page/bankruptcy-local-rules" target="_blank">SD Texas Local Bankruptcy Rules</a> |
                    <a href="https://www.law.cornell.edu/supct/html/02-1016.ZS.html" target="_blank">Till v. SCS Credit Corp.</a><br><br>
                    <strong>Note:</strong> This calculator is for estimation purposes only. Consult with a bankruptcy attorney for actual plan calculations. Trustee fees and interest rates may vary.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let securedCreditors = [];
        let priorityCreditors = [];
        let creditorIdCounter = 0;

        // Update Till rate display
        function updateTillRateDisplay() {
            const primeRate = parseFloat(document.getElementById('primeRate').value) || 0;
            const riskAdjustment = parseFloat(document.getElementById('riskAdjustment').value) || 0;
            const tillRate = primeRate + riskAdjustment;
            document.getElementById('tillRateDisplay').textContent = tillRate.toFixed(2) + '%';
        }

        // Initialize with sample data
        function initializeData() {
            // ABC Mortgage with arrears - CONDUIT treatment
            addSecuredCreditor({
                name: 'ABC Mortgage',
                arrearsAmount: 125000,
                arrearsRate: 7.25,
                isConduit: true,
                conduitPayment: 2100,
                principalBalance: 190000
            });

            // HOA Dues - paid through plan
            addSecuredCreditor({
                name: 'HOA Dues',
                arrearsAmount: 20000,
                arrearsRate: 8.25,
                isConduit: false,
                conduitPayment: 0,
                principalBalance: 0
            });

            // Priority Creditors
            addPriorityCreditor({
                name: 'TWC (Texas Workforce Commission)',
                amount: 700
            });

            addPriorityCreditor({
                name: 'IRS',
                amount: 5000
            });

            // Update Till rate display
            updateTillRateDisplay();

            // Add event listeners for Till rate inputs
            document.getElementById('primeRate').addEventListener('input', updateTillRateDisplay);
            document.getElementById('riskAdjustment').addEventListener('input', updateTillRateDisplay);
        }

        // Add secured creditor
        function addSecuredCreditor(data = null) {
            const id = creditorIdCounter++;
            const defaultData = {
                name: '',
                arrearsAmount: 0,
                arrearsRate: 8.25,
                isConduit: false,
                conduitPayment: 0,
                principalBalance: 0
            };

            const creditor = data || defaultData;
            creditor.id = id;
            securedCreditors.push(creditor);

            const container = document.getElementById('securedCreditors');
            const html = `
                <div class="creditor-item" id="secured-${id}">
                    <button class="btn btn-remove" onclick="removeSecuredCreditor(${id})">Remove</button>
                    <h4>Secured Creditor</h4>
                    <div class="form-group">
                        <label>Creditor Name</label>
                        <input type="text" value="${creditor.name}" onchange="updateSecuredCreditor(${id}, 'name', this.value)">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pre-Petition Arrears ($)</label>
                            <input type="number" value="${creditor.arrearsAmount}" step="100" onchange="updateSecuredCreditor(${id}, 'arrearsAmount', parseFloat(this.value))">
                        </div>
                        <div class="form-group">
                            <label>Contract Interest Rate (%)</label>
                            <input type="number" value="${creditor.arrearsRate}" step="0.125" onchange="updateSecuredCreditor(${id}, 'arrearsRate', parseFloat(this.value))">
                            <small style="color: #718096;">Used if Till rate not selected</small>
                        </div>
                    </div>
                    <div class="sub-section">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" ${creditor.isConduit ? 'checked' : ''} onchange="toggleConduit(${id}, this.checked)">
                                <span>Conduit Payment (ongoing mortgage through trustee)</span>
                            </label>
                        </div>
                        <div id="conduit-${id}" class="${creditor.isConduit ? '' : 'hidden'}">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Monthly Conduit Payment ($)</label>
                                    <input type="number" value="${creditor.conduitPayment}" step="10" onchange="updateSecuredCreditor(${id}, 'conduitPayment', parseFloat(this.value))">
                                    <small style="color: #718096;">Current monthly mortgage payment</small>
                                </div>
                                <div class="form-group">
                                    <label>Principal Balance ($)</label>
                                    <input type="number" value="${creditor.principalBalance}" step="1000" onchange="updateSecuredCreditor(${id}, 'principalBalance', parseFloat(this.value))">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function updateSecuredCreditor(id, field, value) {
            const creditor = securedCreditors.find(c => c.id === id);
            if (creditor) {
                creditor[field] = value;
            }
        }

        function toggleConduit(id, checked) {
            const creditor = securedCreditors.find(c => c.id === id);
            if (creditor) {
                creditor.isConduit = checked;
            }
            const conduitDiv = document.getElementById(`conduit-${id}`);
            if (conduitDiv) {
                conduitDiv.classList.toggle('hidden', !checked);
            }
        }

        function removeSecuredCreditor(id) {
            securedCreditors = securedCreditors.filter(c => c.id !== id);
            const element = document.getElementById(`secured-${id}`);
            if (element) {
                element.remove();
            }
        }

        // Add priority creditor
        function addPriorityCreditor(data = null) {
            const id = creditorIdCounter++;
            const defaultData = {
                name: '',
                amount: 0
            };

            const creditor = data || defaultData;
            creditor.id = id;
            priorityCreditors.push(creditor);

            const container = document.getElementById('priorityCreditors');
            const html = `
                <div class="creditor-item priority" id="priority-${id}">
                    <button class="btn btn-remove" onclick="removePriorityCreditor(${id})">Remove</button>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Creditor Name</label>
                            <input type="text" value="${creditor.name}" onchange="updatePriorityCreditor(${id}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Amount Owed ($)</label>
                            <input type="number" value="${creditor.amount}" step="100" onchange="updatePriorityCreditor(${id}, 'amount', parseFloat(this.value))">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function updatePriorityCreditor(id, field, value) {
            const creditor = priorityCreditors.find(c => c.id === id);
            if (creditor) {
                creditor[field] = value;
            }
        }

        function removePriorityCreditor(id) {
            priorityCreditors = priorityCreditors.filter(c => c.id !== id);
            const element = document.getElementById(`priority-${id}`);
            if (element) {
                element.remove();
            }
        }

        // Calculate amortized payment for secured debt with interest
        function calculateAmortizedTotal(principal, annualRate, months) {
            if (principal <= 0) return 0;
            if (annualRate <= 0) return principal;

            const monthlyRate = annualRate / 100 / 12;
            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            return payment * months;
        }

        // Calculate monthly payment for amortized debt
        function calculateMonthlyPayment(principal, annualRate, months) {
            if (principal <= 0) return 0;
            if (annualRate <= 0) return principal / months;

            const monthlyRate = annualRate / 100 / 12;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Main calculation function
        function calculatePlan() {
            const planMonths = parseInt(document.getElementById('planMonths').value);
            const trusteeFeePercent = parseFloat(document.getElementById('trusteeFee').value);
            const unsecuredPercent = parseFloat(document.getElementById('unsecuredPercent').value);
            const totalUnsecured = parseFloat(document.getElementById('totalUnsecured').value) || 0;
            const useTillRate = document.getElementById('useTillRate').checked;
            const primeRate = parseFloat(document.getElementById('primeRate').value) || 0;
            const riskAdjustment = parseFloat(document.getElementById('riskAdjustment').value) || 0;
            const tillRate = primeRate + riskAdjustment;

            // Calculate secured claims
            let securedArrearsTotal = 0;
            let securedBreakdownHtml = '';
            let securedMonthlyTotal = 0;
            let conduitMonthlyTotal = 0;
            let conduitBreakdownHtml = '';
            let interestRateUsed = useTillRate ? tillRate : null;

            securedCreditors.forEach(creditor => {
                // Calculate arrears with interest
                if (creditor.arrearsAmount > 0) {
                    const rateToUse = useTillRate ? tillRate : creditor.arrearsRate;
                    const arrearsTotal = calculateAmortizedTotal(creditor.arrearsAmount, rateToUse, planMonths);
                    const arrearsMonthly = calculateMonthlyPayment(creditor.arrearsAmount, rateToUse, planMonths);
                    const interestPaid = arrearsTotal - creditor.arrearsAmount;

                    securedArrearsTotal += arrearsTotal;
                    securedMonthlyTotal += arrearsMonthly;

                    securedBreakdownHtml += `
                        <div class="result-item">
                            <span class="label">${creditor.name || 'Secured Creditor'} (Arrears)</span>
                            <span class="value">${formatCurrency(arrearsTotal)}</span>
                        </div>
                        <div class="result-item" style="font-size: 0.85rem; padding: 5px 0;">
                            <span class="label" style="padding-left: 15px;">Principal: ${formatCurrency(creditor.arrearsAmount)} | Interest: ${formatCurrency(interestPaid)} @ ${rateToUse.toFixed(2)}%</span>
                            <span class="value"></span>
                        </div>
                    `;
                }

                // Calculate conduit payments (ongoing mortgage through trustee)
                if (creditor.isConduit && creditor.conduitPayment > 0) {
                    conduitMonthlyTotal += creditor.conduitPayment;
                    const conduitTotal = creditor.conduitPayment * planMonths;
                    conduitBreakdownHtml += `
                        <div class="result-item">
                            <span class="label">${creditor.name || 'Secured Creditor'} (Conduit)</span>
                            <span class="value">${formatCurrency(creditor.conduitPayment)}/mo</span>
                        </div>
                        <div class="result-item" style="font-size: 0.85rem; padding: 5px 0;">
                            <span class="label" style="padding-left: 15px;">Total over ${planMonths} months: ${formatCurrency(conduitTotal)}</span>
                            <span class="value"></span>
                        </div>
                    `;
                }
            });

            // Calculate priority claims (no interest)
            let priorityTotal = 0;
            let priorityBreakdownHtml = '';

            priorityCreditors.forEach(creditor => {
                if (creditor.amount > 0) {
                    priorityTotal += creditor.amount;
                    priorityBreakdownHtml += `
                        <div class="result-item">
                            <span class="label">${creditor.name || 'Priority Creditor'}</span>
                            <span class="value">${formatCurrency(creditor.amount)}</span>
                        </div>
                    `;
                }
            });

            // Calculate unsecured claims
            const unsecuredPayment = totalUnsecured * (unsecuredPercent / 100);
            let unsecuredBreakdownHtml = `
                <div class="result-item">
                    <span class="label">Total Unsecured Debt</span>
                    <span class="value">${formatCurrency(totalUnsecured)}</span>
                </div>
                <div class="result-item">
                    <span class="label">Payment (${unsecuredPercent}%)</span>
                    <span class="value">${formatCurrency(unsecuredPayment)}</span>
                </div>
            `;

            // Calculate totals
            // Total conduit payments over plan term
            const conduitTotalOverPlan = conduitMonthlyTotal * planMonths;

            // Total to creditors = arrears + conduit + priority + unsecured
            const totalToCreditors = securedArrearsTotal + conduitTotalOverPlan + priorityTotal + unsecuredPayment;

            // Trustee fee applies to ALL payments (including conduit)
            // Total Plan Cost = Total to Creditors / (1 - fee%)
            const totalPlanCost = totalToCreditors / (1 - trusteeFeePercent / 100);
            const trusteeFeeAmount = totalPlanCost - totalToCreditors;
            const monthlyPayment = totalPlanCost / planMonths;

            // Calculate monthly breakdown
            const priorityMonthly = priorityTotal / planMonths;
            const unsecuredMonthly = unsecuredPayment / planMonths;
            const trusteeMonthly = trusteeFeeAmount / planMonths;

            const monthlyBreakdownHtml = `
                <tr>
                    <td>Conduit Mortgage</td>
                    <td>${formatCurrency(conduitMonthlyTotal)}</td>
                    <td>${formatCurrency(conduitTotalOverPlan)}</td>
                </tr>
                <tr>
                    <td>Arrears (Principal + Interest)</td>
                    <td>${formatCurrency(securedMonthlyTotal)}</td>
                    <td>${formatCurrency(securedArrearsTotal)}</td>
                </tr>
                <tr>
                    <td>Priority Claims</td>
                    <td>${formatCurrency(priorityMonthly)}</td>
                    <td>${formatCurrency(priorityTotal)}</td>
                </tr>
                <tr>
                    <td>Unsecured (${unsecuredPercent}%)</td>
                    <td>${formatCurrency(unsecuredMonthly)}</td>
                    <td>${formatCurrency(unsecuredPayment)}</td>
                </tr>
                <tr style="border-top: 1px solid rgba(255,255,255,0.3);">
                    <td>Subtotal to Creditors</td>
                    <td>${formatCurrency(conduitMonthlyTotal + securedMonthlyTotal + priorityMonthly + unsecuredMonthly)}</td>
                    <td>${formatCurrency(totalToCreditors)}</td>
                </tr>
                <tr>
                    <td>Trustee Fee (${trusteeFeePercent}%)</td>
                    <td>${formatCurrency(trusteeMonthly)}</td>
                    <td>${formatCurrency(trusteeFeeAmount)}</td>
                </tr>
                <tr style="font-weight: bold; border-top: 2px solid rgba(255,255,255,0.3);">
                    <td>Total Plan Payment</td>
                    <td>${formatCurrency(monthlyPayment)}</td>
                    <td>${formatCurrency(totalPlanCost)}</td>
                </tr>
            `;

            // Interest rate info
            const interestRateHtml = useTillRate ? `
                <div class="result-item">
                    <span class="label">Till Rate (Prime + Risk)</span>
                    <span class="value">${primeRate}% + ${riskAdjustment}% = ${tillRate.toFixed(2)}%</span>
                </div>
                <div class="result-item" style="font-size: 0.85rem; padding: 5px 0;">
                    <span class="label">Per Till v. SCS Credit Corp., 541 U.S. 465 (2004)</span>
                    <span class="value"></span>
                </div>
            ` : `
                <div class="result-item">
                    <span class="label">Using Contract Rates</span>
                    <span class="value">Varies by creditor</span>
                </div>
            `;

            // Update UI
            document.getElementById('conduitBreakdown').innerHTML = conduitBreakdownHtml || '<div class="result-item"><span class="label">No conduit payments</span><span class="value">$0.00</span></div>';
            document.getElementById('securedBreakdown').innerHTML = securedBreakdownHtml || '<div class="result-item"><span class="label">No arrears</span><span class="value">$0.00</span></div>';
            document.getElementById('priorityBreakdown').innerHTML = priorityBreakdownHtml || '<div class="result-item"><span class="label">No priority claims</span><span class="value">$0.00</span></div>';
            document.getElementById('unsecuredBreakdown').innerHTML = unsecuredBreakdownHtml;

            document.getElementById('totalToCreditors').textContent = formatCurrency(totalToCreditors);
            document.getElementById('trusteeFeePercent').textContent = trusteeFeePercent;
            document.getElementById('trusteeFeeAmount').textContent = formatCurrency(trusteeFeeAmount);
            document.getElementById('totalPlanCost').textContent = formatCurrency(totalPlanCost);
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);

            document.getElementById('monthlyBreakdown').innerHTML = monthlyBreakdownHtml;
            document.getElementById('interestRateInfo').innerHTML = interestRateHtml;

            // Show results
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('detailsCard').style.display = 'block';

            // Scroll to results
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeData);
    </script>
</body>
</html>
