import SwiftUI

struct TermsOfServiceView: View {
    @Environment(\.dismiss) var dismiss
    @State private var hasScrolledToBottom = false
    @State private var scrollOffset: CGFloat = 0
    @Binding var isAccepted: Bool

    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // Scrollable TOS Content
                ScrollViewReader { proxy in
                    ScrollView {
                        VStack(alignment: .leading, spacing: 16) {
                            tosHeader

                            Group {
                                tosSection1NoLegalAdvice
                                tosSection2AIAccuracy
                                tosSection3AB5Compliance
                                tosSection4DataOwnership
                                tosSection5LimitationOfLiability
                                tosSection6SubscriptionTerms
                                tosSection7PrivacyPolicy
                                tosSection8Termination
                                tosSection9GoverningLaw
                                tosSection10ContactInfo
                            }

                            // Bottom anchor for scroll detection
                            Color.clear
                                .frame(height: 1)
                                .id("bottom_anchor")
                                .onAppear {
                                    withAnimation { hasScrolledToBottom = true }
                                }
                        }
                        .padding()
                    }
                }

                // Action Footer
                actionFooter
            }
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel") {
                        dismiss()
                    }
                }
            }
        }
    }

    // MARK: - TOS Header

    private var tosHeader: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("BizDeedz Terms of Service")
                .font(.title.bold())

            Text("Last Updated: January 2026")
                .font(.caption)
                .foregroundColor(.secondary)

            Text("Please read these terms carefully before using BizDeedz Filing Tracker.")
                .font(.subheadline)
                .foregroundColor(.secondary)
                .padding(.top, 4)

            Divider()
                .padding(.vertical, 8)
        }
    }

    // MARK: - Section 1: No Legal Advice

    private var tosSection1NoLegalAdvice: some View {
        TOSSection(
            title: "1. No Legal Advice Disclaimer",
            content: """
            BizDeedz provides document management and workflow automation tools. We do not provide legal advice, and our software is not a substitute for the advice of a licensed attorney.

            ATTORNEY OVERSIGHT REQUIRED: All users acknowledge that any output, filing, or document generated by the app must be reviewed and approved by a licensed attorney of record before submission to any court or governmental agency.

            Use of BizDeedz does not create an attorney-client relationship between you and BizDeedz, its affiliates, or employees.
            """
        )
    }

    // MARK: - Section 2: AI & Third-Party Data

    private var tosSection2AIAccuracy: some View {
        TOSSection(
            title: "2. Accuracy of AI & Third-Party Data",
            content: """
            While we strive for accuracy, BizDeedz relies on artificial intelligence and third-party court portal data. We do not warrant that the information is always current, complete, or error-free.

            HUMAN-IN-THE-LOOP REQUIREMENT: Users are responsible for independently verifying all filing deadlines, court requirements, and document accuracy before submission.

            BizDeedz is not responsible for any consequences arising from reliance on AI-generated suggestions or third-party data without independent verification.
            """
        )
    }

    // MARK: - Section 3: AB5 & Contractor Status

    private var tosSection3AB5Compliance: some View {
        TOSSection(
            title: "3. AB5 & Independent Contractor Status",
            content: """
            BizDeedz is a platform for connection and organization only. We do not employ the paralegals, contractors, or service providers listed on or using the platform.

            COMPLIANCE RESPONSIBILITY: Users in jurisdictions like California are solely responsible for ensuring their working relationships comply with AB5 or similar "ABC" worker classification tests.

            BizDeedz provides informational tools regarding compliance but does not provide legal determination of worker classification status.
            """
        )
    }

    // MARK: - Section 4: Data Ownership & Security

    private var tosSection4DataOwnership: some View {
        TOSSection(
            title: "4. Data Ownership & Security",
            content: """
            USER OWNERSHIP: The User (the firm or paralegal) retains all rights and ownership of the data they upload to BizDeedz, including documents, case information, and filing records.

            SECURITY MEASURES: BizDeedz employs industry-standard encryption (AES-256) and multi-factor authentication options. Data is stored on secure, SOC 2 compliant servers.

            CREDENTIAL RESPONSIBILITY: Users are responsible for maintaining the confidentiality of their login credentials and must notify BizDeedz immediately of any unauthorized access.

            DATA MINIMIZATION: BizDeedz only collects metadata necessary to track filing status (timestamps, county identifiers, status changes).
            """
        )
    }

    // MARK: - Section 5: Limitation of Liability

    private var tosSection5LimitationOfLiability: some View {
        TOSSection(
            title: "5. Limitation of Liability",
            content: """
            To the maximum extent permitted by law, BizDeedz shall not be liable for any indirect, incidental, special, consequential, or punitive damages, including but not limited to:

            \u{2022} Lost profits or revenue
            \u{2022} Missed court deadlines
            \u{2022} Rejected filings
            \u{2022} Data loss
            \u{2022} Business interruption

            LIABILITY CAP: In no event shall BizDeedz's total liability exceed the amount paid by the user for the service in the twelve (12) months immediately preceding the claim.

            Some jurisdictions do not allow limitations on implied warranties or exclusion of certain damages. In such jurisdictions, the limitations shall apply to the fullest extent permitted by law.
            """
        )
    }

    // MARK: - Section 6: Subscription Terms

    private var tosSection6SubscriptionTerms: some View {
        TOSSection(
            title: "6. Subscription & Payment Terms",
            content: """
            BILLING: Subscriptions are billed monthly in advance. All fees are non-refundable except as required by law or as explicitly stated in this agreement.

            TRIAL PERIOD: New users receive a 7-day free trial. You may cancel at any time during the trial without charge.

            CANCELLATION: You may cancel your subscription at any time. Cancellation takes effect at the end of the current billing period.

            PRICE CHANGES: BizDeedz reserves the right to modify pricing with 30 days' notice. Continued use after the notice period constitutes acceptance of new pricing.

            Current pricing:
            \u{2022} Solo Paralegal: $29/month
            \u{2022} Law Firm: $199/month
            \u{2022} Enterprise: Custom pricing
            """
        )
    }

    // MARK: - Section 7: Privacy Policy Reference

    private var tosSection7PrivacyPolicy: some View {
        TOSSection(
            title: "7. Privacy Policy",
            content: """
            Your privacy is important to us. Our Privacy Policy, incorporated by reference into these Terms, describes how we collect, use, and protect your information.

            Key points:
            \u{2022} We collect only necessary data for service operation
            \u{2022} We do not sell your personal information
            \u{2022} We comply with CCPA, CPRA, and applicable privacy laws
            \u{2022} You have the right to request data deletion ("Right to Erasure")
            \u{2022} We use AI for service improvement; see our ADMT disclosure

            For the full Privacy Policy, please visit our website or contact support.
            """
        )
    }

    // MARK: - Section 8: Termination

    private var tosSection8Termination: some View {
        TOSSection(
            title: "8. Termination",
            content: """
            TERMINATION BY USER: You may terminate your account at any time by contacting support or using the account settings.

            TERMINATION BY BIZDEEDZ: We may suspend or terminate your access if you:
            \u{2022} Violate these Terms of Service
            \u{2022} Engage in fraudulent or illegal activity
            \u{2022} Fail to pay applicable fees
            \u{2022} Abuse the platform or other users

            EFFECT OF TERMINATION: Upon termination, your right to use the service ceases immediately. You may request export of your data within 30 days of termination.
            """
        )
    }

    // MARK: - Section 9: Governing Law

    private var tosSection9GoverningLaw: some View {
        TOSSection(
            title: "9. Governing Law & Dispute Resolution",
            content: """
            GOVERNING LAW: These Terms shall be governed by and construed in accordance with the laws of the State of Texas, without regard to its conflict of law provisions.

            DISPUTE RESOLUTION: Any dispute arising from these Terms shall first be attempted to be resolved through informal negotiation. If unsuccessful, disputes shall be resolved through binding arbitration in accordance with the rules of the American Arbitration Association.

            CLASS ACTION WAIVER: You agree to resolve disputes individually and waive any right to participate in a class action lawsuit or class-wide arbitration.
            """
        )
    }

    // MARK: - Section 10: Contact Information

    private var tosSection10ContactInfo: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("10. Contact Information")
                .font(.headline)

            Text("""
            For questions about these Terms of Service, please contact us:

            BizDeedz Legal Operations Platform
            Email: legal@bizdeedz.com
            Support: support@bizdeedz.com

            Mailing Address:
            BizDeedz, Inc.
            1234 Legal Tech Way
            Austin, TX 78701
            """)
            .font(.body)

            Divider()
                .padding(.vertical, 16)

            Text("By clicking \"I Agree and Accept\" below, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service.")
                .font(.subheadline)
                .fontWeight(.medium)
                .foregroundColor(.primary)
        }
        .padding(.vertical, 8)
    }

    // MARK: - Action Footer

    private var actionFooter: some View {
        VStack(spacing: 12) {
            Button(action: {
                isAccepted = true
                dismiss()
            }) {
                Text("I Agree and Accept")
                    .fontWeight(.semibold)
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background(hasScrolledToBottom ? Color.blue : Color.gray)
                    .foregroundColor(.white)
                    .cornerRadius(12)
            }
            .disabled(!hasScrolledToBottom)

            if !hasScrolledToBottom {
                HStack {
                    Image(systemName: "arrow.down.circle")
                    Text("Please scroll to the bottom to accept")
                }
                .font(.caption)
                .foregroundColor(.secondary)
            }
        }
        .padding()
        .background(Color(.secondarySystemGroupedBackground))
    }
}

// MARK: - TOS Section Component

struct TOSSection: View {
    let title: String
    let content: String

    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text(title)
                .font(.headline)

            Text(content)
                .font(.body)
                .foregroundColor(.secondary)

            Divider()
                .padding(.vertical, 8)
        }
    }
}

// MARK: - Preview

#Preview {
    TermsOfServiceView(isAccepted: .constant(false))
}
